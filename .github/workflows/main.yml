name: "Create Release"
on:
  push:
    branches:
      - master
jobs:
  create-gh-release:
    name: "Create Release"
    runs-on: ubuntu-latest
    outputs:
      release-url: ${{ steps.create_release.outputs.html_url}}
      release-number: ${{ steps.release-number.outputs.release-number}}
    steps:
      - name: "Checkout"
        uses: actions/checkout@master
      - name: "Create GitHub Release"
        id: create_release
        uses: actions/create-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.release.tag_name }}
          release_name: Release ${{ github.event.release.tag_name }}
          draft: false
          prerelease: false
  create-octopus-release:
    name: "Create Octopus Release"
    runs-on: ubuntu-latest
    needs:
      - create-gh-release
    strategy:
      matrix:
        octopus-project:
          - "Project1"
          - "Project2"
          - "Project3"
    steps:
      - name: "Create ${{ matrix.octopus-project }} Octopus Release"
        uses: docker://octopusdeploy/octo
        with:
          args: >
            create-release
            --server ${{ secrets.OCTOPUS_SERVER }}
            --project "${{ matrix.octopus-project }}"
            --version ${{ needs.create-gh-release.outputs.release-number }}
            --channel Default
            --apikey ${{ secrets.OCTOPUS_API_KEY }}
            --releasenotes "[View release in GitHub](${{ needs.create-gh-release.outputs.release-url }})"